\documentclass[a4paper,12pt]{article}
\usepackage{amsmath,amssymb}
\usepackage{tikz}
\usepackage{fullpage}
\usepackage{bm}
\usepackage{float}
\usetikzlibrary{bayesnet}
\DeclareMathOperator{\E}{\mathbb{E}}

\begin{document}


\begin{align*}
    &\text{Observation model} \\
    &{y_i}^{p,m}\sim \text{Gamma}\left({\mu_i}^{p,m}\cdot{\beta_i}^{p,m}, {\beta_i}^{p,m}\right) \\
    &{\mu_i}^{p,m} \gets \mathcal{F}\left({x_i}^{p,m} \mid a^{p,m}, {\Omega}^{p,m}\right) \\
    &{\beta_i}^{p,m} \gets {c_1}^{p,m} + \frac{{\mu_i}^{p,m}}{{c_2}^{p,m}}\\\\
    &\text{Participant specific parameters} \\
    &a^{p,m} \sim \text{TruncatedNormal}\left({\mu_a}^{m}, {\sigma_a}^{m}\right)\\
    &{\theta}^{p,m} \sim \text{HalfNormal}\left({\sigma_{\theta}}^{m}\right) \text{ for all } \theta^{p,m} \in {\Omega}^{p,m}\\\\
    &\text{Priors} \\
    & {\mu_a}^m \sim \text{TruncatedNormal}\left(50, 20\right)\\
    &{\sigma_a}^m \sim \text{HalfNormal}\left(30\right)\\
    &{\sigma_L}^{m} \sim \text{HalfNormal}\left(0.05\right)\\
    &{\sigma_\theta}^m \sim \text{HalfNormal}\left(5\right) \text{ for all } {\sigma_\theta}^m2{\sigma_{b}}^m,  ^{p,m} \in \Omega^m\\\\
    &{\Omega}^{p,m} \gets \{{b}^{p,m}, {v}^{p,m}, {L}^{p,m}, {\ell}^{p,m}, {H}^{p,m}, {c_1}^{p,m}, {c_2}^{p,m}\}\\
    &\Omega^m \gets \{{\sigma_{b}}^m, {\sigma_{v}}^m,  {\sigma_{\ell}}^m, {\sigma_{H}}^m, {\sigma_{c_1}}^m, {\sigma_{c_2}}^m\}
\end{align*}

\begin{figure}[H]
    \centering
    \tikz{ %
        % Obs
        \node[obs,fill,minimum size=1cm] (obs) {${y_i}^{p,m}$};%

        % Deterministic mu, beta
        \node[det,above=of obs,xshift=-1.2cm,yshift=-.5cm,fill,minimum size=1cm] (beta) {${\beta_i}^{p,m}$}; %
        \node[det,above=of obs,xshift=1.2cm,yshift=.2cm,fill,minimum size=1cm] (mu) {${\mu_i}^{p,m}$}; %
        \node[obs,above=of obs,xshift=-.8cm,yshift=1.5cm,fill,minimum size=1cm] (intensity) {${x_i}^{p,m}$};%
        \plate[inner sep=.1cm, yshift=.07cm] {plate_obs} {(obs)(mu)(beta)(intensity)} {$\text{intensity }i: 1, 2 \ldots N_p$};

        % % PRIORS
        % a, b, v
        \node[latent,above=of obs,yshift=3cm,xshift=-1.5cm,fill,minimum size=.8cm] (a) {$a^{p,m}$};
        \node[latent,right=of a,xshift=-.3cm,fill,minimum size=.8cm] (b) {$b^{p,m}$};
        \node[latent,right=of b,xshift=-.9cm,fill,minimum size=.8cm] (v) {$v^{p,m}$};
        % L, ell, H
        \node[latent,right=of v,xshift=-.9cm,fill,minimum size=.8cm] (L) {$L^{p,m}$};
        \node[latent,right=of L,xshift=-.9cm,fill,minimum size=.8cm] (ell) {$\ell^{p,m}$};
        \node[latent,right=of ell,xshift=-.9cm,fill,minimum size=.8cm] (H) {$H^{p,m}$};
        % g1, g2
        \node[latent,left=of a,xshift=.3cm,fill,minimum size=.8cm] (g2) {${c_2}^{p,m}$};
        \node[latent,left=of g2,xshift=.9cm,fill,minimum size=.8cm] (g1) {${c_1}^{p,m}$};

        % Participants plate
        \plate[inner sep=.1cm, yshift=.07cm] {plate_participant} {(a)(b)(L)(H)(v)(ell)(g1)(g2)(plate_obs)} {$\text{participant }p : 1, 2 \ldots P$};

        % % HYPER-PRIORS
        \node[latent,above=of a,xshift=-.43cm,fill,minimum size=.8cm] (a_mean) {${\mu_a}^m$};
        \node[latent,above=of a,xshift=.43cm,fill,minimum size=.8cm] (a_scale) {${\sigma_a}^m$};
        \node[latent,above=of b,fill,minimum size=.8cm] (b_scale) {${\sigma_b}^m$};
        \node[latent,above=of g2,fill,minimum size=.8cm] (g2_scale) {${\sigma_{c_2}}^m$};
        \node[latent,above=of g1,fill,minimum size=.8cm] (g1_scale) {${\sigma_{c_1}}^m$};
        \node[latent,above=of L,fill,minimum size=.8cm] (L_scale) {${\sigma_L}^m$};
        \node[latent,above=of H,fill,minimum size=.8cm] (H_scale) {${\sigma_H}^m$};
        \node[latent,above=of v,fill,minimum size=.8cm] (v_scale) {${\sigma_v}^m$};
        \node[latent,above=of ell,fill,minimum size=.8cm] (ell_scale) {${\sigma_\ell}^m$};

        % Muscles plate
        \plate[inner sep=.25cm, yshift=.2cm] {muscle_plate} {(a_mean)(a_scale)(b_scale)(L_scale)(H_scale)(v_scale)(ell_scale)(g1_scale)(g2_scale)(plate_participant)} {$\text{muscle }m : 1, 2 \ldots M$};

        % Edges from Hyper-priors to Priors
        \edge {g1_scale} {g1}
        \edge {g2_scale} {g2}
        \edge {a_mean, a_scale} {a}
        \edge {b_scale} {b}
        \edge {L_scale} {L}
        \edge {H_scale} {H}
        \edge {v_scale} {v}
        \edge {ell_scale} {ell}

        % Edges from Priors to Deterministic
        \edge {g1, g2} {beta}
        \edge {a, b, v, L, ell, H} {mu}

        % Edges to obs
        \edge {intensity} {beta, mu}
        \edge {beta,mu} {obs};
        \edge {mu} {beta};
    }
\end{figure}
\end{document}
