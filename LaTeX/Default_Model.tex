\documentclass[a4paper,12pt]{article}
\usepackage{amsmath,amssymb}
\usepackage{tikz}
\usepackage{fullpage}
\usepackage{bm}
\usepackage{float}
\usetikzlibrary{bayesnet}
\DeclareMathOperator{\E}{\mathbb{E}}

\begin{document}

The simplest form of a standard 3-stage hierarchical Bayesian model in the context of modeling MEP size can be described as follows. Let there be $N_P$ exchangeable sequences $\left\{\left({x_i}^p, {y_i}^p\right)_{i=1}^{n(p)} \mid j = 1, 2 \ldots N_P\right\}$ of MEP sizes ${y_i}^p \in \mathbb{R}^+$ recorded at stimulation intensity ${x_i}^p \in \mathbb{R}_0^+$ from $p^{\text{th}}$ participant, for  a total of $N_P$ participants. Here $n(p)$ denotes the number of intensities tested for $p^{\text{th}}$ participant.\\

The first stage of hierarchy is the \textit{participant-level} and specifies parametric model $P\left({y_i}^p \mid {x_i}^p, \theta^p\right)$ for each of the $N_P$ participants and models the MEP size ${y_i}^p$ as a function of stimulus intensity ${x_i}^p$ and participant-specific parameters $\theta^p$. In the second stage, $\theta_1, \theta_2 \ldots \theta^P$ are assumed to be exchangeable and generated from a common distribution $P\left(\theta^p \mid \gamma\right)$ with hyper-parameters $\gamma$. In the third stage, the hyper-parameters $\gamma$ are assumed to be unknown and assigned \textit{weakly-informative} prior, also called hyperprior-density $P\left(\gamma\right)$.
\begin{align*}
{y_i}^p \mid {x_i}^p, \theta^p, \gamma &\sim P\left({y_i}^p \mid {x_i}^p, \theta^p, \gamma\right) \tag{4.2.1} \\
\theta^p \mid \gamma &\sim P\left(\theta^p \mid \gamma\right) \tag{4.2.2} \\
\gamma &\sim P\left(\gamma\right) \tag{4.2.3}
\end{align*}
Figure $4.3.1$ shows the graphical representation of the default hierarchical model implemented by hbmep for fitting recruitment-curves on TMS data [ref.] in [ref. to function comparison fig.].\\
\begin{figure}[H]
    \centering
    \tikz{ %
        % Obs
        \node[obs,fill,] (obs) {${y_i}^{p}$};%

        % Deterministic mu, beta
        \node[det,above=of obs,xshift=-1.2cm,yshift=-.5cm,fill,] (beta) {${\beta_i}^{p}$}; %
        \node[det,above=of obs,xshift=1.2cm,yshift=.2cm,fill,] (mu) {${\mu_i}^{p}$}; %
        \node[obs,above=of obs,xshift=-.8cm,yshift=1.5cm,fill,] (intensity) {${x_i}^{p}$};%
        \plate[inner sep=.1cm, yshift=.07cm] {plate_obs} {(obs)(mu)(beta)(intensity)} {$\text{intensity }i: 1, 2 \ldots n(p)$};

        % % PRIORS
        % a, b, v
        \node[latent,above=of obs,yshift=3cm,xshift=-1cm,fill,] (a) {$a^{p}$};
        \node[latent,right=of a,xshift=-.3cm,fill,] (b) {$b^{p}$};
        % \node[latent,right=of b,xshift=-.9cm,fill,] (v) {$v^{p}$};
        % L, ell, H
        \node[latent,right=of b,xshift=-.9cm,fill,] (L) {$L^{p}$};
        \node[latent,right=of L,xshift=-.9cm,fill,] (ell) {$\ell^{p}$};
        \node[latent,right=of ell,xshift=-.9cm,fill,] (H) {$H^{p}$};
        % g1, g2
        \node[latent,left=of a,xshift=.3cm,fill,] (g2) {${c_2}^{p}$};
        \node[latent,left=of g2,xshift=.9cm,fill,] (g1) {${c_1}^{p}$};

        % Participants plate
        \plate[inner sep=.1cm, yshift=.07cm] {plate_participant} {(a)(b)(L)(H)(ell)(g1)(g2)(plate_obs)} {$\text{participant }p : 1, 2 \ldots N_P$};

        % % HYPER-PRIORS
        \node[latent,above=of a,xshift=-.43cm,fill,] (a_mean) {${\mu_a}$};
        \node[latent,above=of a,xshift=.43cm,fill,] (a_scale) {${\sigma_a}$};
        \node[latent,above=of b,fill] (b_scale) {${\sigma_b}$};
        \node[latent,above=of g2,fill] (g2_scale) {${\sigma_{c_2}}$};
        \node[latent,above=of g1,fill,] (g1_scale) {${\sigma_{c_1}}$};
        \node[latent,above=of L,fill,] (L_scale) {${\sigma_L}$};
        \node[latent,above=of H,fill,] (H_scale) {${\sigma_H}$};
        % \node[latent,above=of v,fill,] (v_scale) {${\sigma_v}$};
        \node[latent,above=of ell,fill,] (ell_scale) {${\sigma_\ell}$};

        % Edges from Hyper-priors to Priors
        \edge {g1_scale} {g1}
        \edge {g2_scale} {g2}
        \edge {a_mean, a_scale} {a}
        \edge {b_scale} {b}
        \edge {L_scale} {L}
        \edge {H_scale} {H}
        % \edge {v_scale} {v}
        \edge {ell_scale} {ell}

        % Edges from Priors to Deterministic
        \edge {g1, g2} {beta}
        \edge {a, b, L, ell, H} {mu}

        % Edges to obs
        \edge {intensity} {beta, mu}
        \edge {beta,mu} {obs};
        \edge {mu} {beta};
        \plate[inner sep=.1cm, yshift=.07cm] {plate_muscle} {(a_mean)(a_scale)(b_scale)(L_scale)(ell_scale)(H_scale)(plate_participant)} {$\text{muscle }m : 1, 2 \ldots N_M$};
    }
\end{figure}

\begin{align*}
    &\text{Observation model} \\
    &{y_i}^{p}\sim \text{Gamma}\left({\mu_i}^{p}\cdot{\beta_i}^{p}, {\beta_i}^{p}\right) \\
    &{\mu_i}^{p} \gets \mathcal{F}\left({x_i}^{p} \mid a^{p}, {\Omega}^{p}\right) \\
    &{\beta_i}^{p} \gets \frac1{{c_1}^{p}} + \frac1{{c_2}^{p}\cdot{\mu_i}^{p}}\\\\
    &\text{Participant specific parameters} \\
    &a^{p} \sim \text{TruncatedNormal}\left({\mu_a}, {\sigma_a}\right)\\
    &{\theta}^{p} \sim \text{HalfNormal}\left({\sigma_{\theta}}\right) \forall \theta^{p} \in {\Omega}^{p}\\\\
    &\text{Priors} \\
    & {\mu_a} \sim \text{TruncatedNormal}\left(50, 20\right)\\
    &{\sigma_a} \sim \text{HalfNormal}\left(30\right)\\
    &{\sigma_L} \sim \text{HalfNormal}\left(0.05\right)\\
    &{\sigma_\theta} \sim \text{HalfNormal}\left(5\right) \forall {\sigma_\theta}\in \Omega\\\\
    &{\Omega}^{p} \gets \left\{{b}^{p}, {L}^{p}, {\ell}^{p}, {H}^{p}, {c_1}^{p}, {c_2}^{p}\right\}\\
    &\Omega \gets \left\{{\sigma_{b}},  {\sigma_{\ell}}, {\sigma_{H}}, {\sigma_{c_1}}, {\sigma_{c_2}}\right\}
\end{align*}

\end{document}
