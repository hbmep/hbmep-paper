\documentclass[a4paper,12pt]{article}
\usepackage{amsmath,amssymb}
\usepackage{tikz}
\usepackage{fullpage}
\usepackage{bm}
\usepackage{float}
\usetikzlibrary{bayesnet}
\DeclareMathOperator{\E}{\mathbb{E}}

\begin{document}

More often than not, $y_i^p$ is not a scalar but an $M-$ dimensional vector $y_i^p = (y_i^{p, 0} \ldots y_i^{p, M})$ of MEP sizes $y_i^{p, m} \in \mathbb{R}^+$ recorded from $m^{th}$ muscle, for a total of $M$ muscles. hbmep extends the default model to accommodate $M-$ dimensional MEP sizes by assuming that the MEP sizes $y_i^{p, m}$ are independent given the stimulus intensity $x_i^p$ and muscle specific parameters $\theta_p^m$.
\begin{align*}
    y_i^{p, m} \mid x_i^p, \theta_{p, m}, \gamma &\sim P(y_i^{p, m} \mid x_i^p, \theta_{p, m}, \gamma_m) \tag{4.3.4} \\
    \theta_{p, m} \mid \gamma &\sim P(\theta_{p, m} \mid \gamma_m) \tag{4.3.5} \\
    \gamma_m &\sim P(\gamma_m) \tag{4.3.6}
\end{align*}

Fig. 4.3.4 shows how the group model from section 4.3.2 extends to handle multiple muscles.

\begin{figure}[H]
    \centering
    \tikz{ %
        % Obs
        \node[obs,fill] (obs) {$y$};%

        % Deterministic mu, beta
        \node[det,above=of obs,xshift=-1.2cm,yshift=-.5cm,fill] (beta) {$\beta$}; %
        \node[det,above=of obs,xshift=1.2cm,yshift=0cm,fill] (mu) {$\mu$}; %
        \node[obs,above=of obs,xshift=-.8cm,yshift=1cm,fill] (intensity) {$x$};%
        \plate[inner sep=.1cm, yshift=.07cm] {plate_obs} {(obs)(mu)(beta)(intensity)} {$i: 1, 2 \ldots n(p)$};

        % % PRIORS
        % a, b, v
        \node[latent,above=of obs,yshift=2.2cm,xshift=-1.3cm,fill] (a) {$a$};
        \node[latent,right=of a,xshift=-.4cm,fill] (b) {$b$};
        \node[latent,right=of b,xshift=-.9cm,fill] (v) {$v$};
        % L, ell, H
        \node[latent,right=of v,xshift=-.9cm,fill] (L) {$L$};
        \node[latent,right=of L,xshift=-.9cm,fill] (ell) {$\ell$};
        \node[latent,right=of ell,xshift=-.9cm,fill] (H) {$H$};
        % g1, g2
        \node[latent,left=of a,xshift=.3cm,fill] (g2) {${c_2}$};
        \node[latent,left=of g2,xshift=.9cm,fill] (g1) {${c_1}$};

        % Participants plate
        \plate[inner sep=.25cm, yshift=.2cm] {plate_participant} {(a)(b)(L)(H)(v)(ell)(g1)(g2)(plate_obs)} {$p:1, 2 \ldots N(g)$};

        % % HYPER-PRIORS
        \node[latent,above=of a,xshift=-.4cm,fill] (a_mean) {$\mu_a$};
        \node[latent,above=of a,xshift=.4cm,fill] (a_scale) {$\sigma_a$};
        \node[latent,above=of b,fill] (b_scale) {$\sigma_b$};
        \node[latent,above=of g2,fill] (g2_scale) {$\sigma_{c_2}$};
        \node[latent,above=of g1,fill] (g1_scale) {$\sigma_{c_1}$};
        \node[latent,above=of L,fill] (L_scale) {$\sigma_L$};
        \node[latent,above=of H,fill] (H_scale) {$\sigma_H$};
        \node[latent,above=of v,fill] (v_scale) {$\sigma_v$};
        \node[latent,above=of ell,fill] (ell_scale) {$\sigma_\ell$};

        % Groups plate
        \plate[inner sep=.25cm, yshift=.2cm] {plate_group} {(a_mean)(a_scale)(b_scale)(g1_scale)(g2_scale)(L_scale)(H_scale)(v_scale)(ell_scale)(plate_participant)} {$g: 1, 2 \ldots N_G$};

        % GLOBAL PRIORS
        \node[latent,above=of g2_scale,xshift=.05cm,fill] (g2_scale_global_scale) {$\sigma_{\sigma_{c_2}}$};
        \node[latent,above=of g1_scale,xshift=-.05cm,fill] (g1_scale_global_scale) {$\sigma_{\sigma_{c_1}}$};
        \node[latent,above=of b_scale,fill] (b_scale_global_scale) {$\sigma_{\sigma_{b}}$};
        \node[latent,above=of L_scale,fill] (L_scale_global_scale) {$\sigma_{\sigma_L}$};
        \node[latent,above=of H_scale,fill] (H_scale_global_scale) {$\sigma_{\sigma_H}$};
        \node[latent,above=of v_scale,fill] (v_scale_global_scale) {$\sigma_{\sigma_v}$};
        \node[latent,above=of ell_scale,fill] (ell_scale_global_scale) {$\sigma_{\sigma_\ell}$};

        % Response plate
        \plate[inner sep=.1cm, yshift=.02cm] {plate_Response} {(b_scale_global_scale)(L_scale_global_scale)(H_scale_global_scale)(v_scale_global_scale)(ell_scale_global_scale)(g1_scale_global_scale)(g2_scale_global_scale)(plate_group)} {$m: 1, 2 \ldots N_M$};

        % Edges from Global-priors to Priors
        \edge {g1_scale_global_scale} {g1_scale}
        \edge {g2_scale_global_scale} {g2_scale}
        \edge {b_scale_global_scale} {b_scale}
        \edge {L_scale_global_scale} {L_scale}
        \edge {H_scale_global_scale} {H_scale}
        \edge {v_scale_global_scale} {v_scale}
        \edge {ell_scale_global_scale} {ell_scale}

        % Edges from Hyper-priors to Priors
        \edge {g1_scale} {g1}
        \edge {g2_scale} {g2}
        \edge {a_mean, a_scale} {a}
        \edge {b_scale} {b}
        \edge {L_scale} {L}
        \edge {H_scale} {H}
        \edge {v_scale} {v}
        \edge {ell_scale} {ell}

        % Edges from Priors to Deterministic
        \edge {g1, g2} {beta}
        \edge {a, b, v, L, ell, H} {mu}

        % Edges to obs
        \edge {intensity} {beta, mu}
        \edge {beta,mu} {obs};
        \edge {mu} {beta};
    }
\end{figure}

\pagebreak
\begin{align*}
    y \mid x, \Omega &\sim \left(1 - q_y\right)\cdot\mathcal{G}\left(\mu\beta, \beta\right) + q_y \cdot \mathcal{HN}\left(\sigma_{\text{outlier}}\right) \tag{4.3.7} \\
    q_y &\sim \mathrm{Bern}\left(p_{\text{outlier}}\right) \tag{4.3.8} \\
    p_{\text{outlier}} &\sim \mathrm{Unif}\left(0, C_{p_{\text{outlier}}}\right) \tag{4.3.9} \\
    \sigma_{\text{outlier}} &\sim \mathcal{HN}\left(C_{\sigma_{\text{outlier}}}\right) \tag{4.3.10}
    % &y \mid x, \Omega \sim \left(1 - \mathrm{Bern}\left(p_{\text{outlier}}\right)\right)\cdot\mathcal{G}\left(\mu\beta, \beta\right) + \mathrm{Bern}\left(p_{\text{outlier}}\right) \cdot \mathcal{HN}\left(\sigma_{\text{outlier}}\right) \tag{4.2.2} \\
\end{align*}

where $C_{p_{\text{outlier}}}, C_{\sigma_{\text{outlier}}} > 0$ are constants and $C_{p_{\text{outlier}}} < 1$ is chosen to be very small, usually in the range $0.01 - 0.02$. Intuitively, this means we expect there to be roughly $1\% - 2\%$ outliers which will be captured by the HalfNormal distribution.

\begin{figure}[H]
    \centering
    \tikz{ %
        % Obs
        \node[obs,fill] (obs) {$y$};%

        % Deterministic mu, beta
        \node[det,above=of obs,xshift=-1.2cm,yshift=-.5cm,fill] (beta) {$\beta$}; %
        \node[det,above=of obs,xshift=1.2cm,yshift=0cm,fill] (mu) {$\mu$}; %
        \node[obs,above=of obs,xshift=-.8cm,yshift=1cm,fill] (intensity) {$x$};%
        \node[latent,left=of obs,xshift=0cm,yshift=.5cm,fill] (binary_obs) {$q_y$};%
        \plate[inner sep=.1cm, yshift=.07cm] {plate_obs} {(obs)(mu)(beta)(intensity)(binary_obs)} {$i: 1, 2 \ldots n(p)$};

        % Outlier distribution
        \node[latent,left=of intensity,xshift=-2.6cm,yshift=-1cm,fill] (p_outlier) {$p_{\text{outlier}}$};
        \node[latent,above=of p_outlier,xshift=0cm,yshift=-.8cm,fill] (outlier_scale) {$\sigma_{\text{outlier}}$};

        % % PRIORS
        % a, b, v
        \node[latent,above=of obs,yshift=2.2cm,xshift=-1.3cm,fill] (a) {$a$};
        \node[latent,right=of a,xshift=-.4cm,fill] (b) {$b$};
        \node[latent,right=of b,xshift=-.9cm,fill] (v) {$v$};
        % L, ell, H
        \node[latent,right=of v,xshift=-.9cm,fill] (L) {$L$};
        \node[latent,right=of L,xshift=-.9cm,fill] (ell) {$\ell$};
        \node[latent,right=of ell,xshift=-.9cm,fill] (H) {$H$};
        % g1, g2
        \node[latent,left=of a,xshift=.3cm,fill] (g2) {${c_2}$};
        \node[latent,left=of g2,xshift=.9cm,fill] (g1) {${c_1}$};

        % Participants plate
        \plate[inner sep=.25cm, yshift=.2cm] {plate_participant} {(a)(b)(L)(H)(v)(ell)(g1)(g2)(plate_obs)} {$p:1, 2 \ldots N(g)$};

        % % HYPER-PRIORS
        \node[latent,above=of a,xshift=-.4cm,fill] (a_mean) {$\mu_a$};
        \node[latent,above=of a,xshift=.4cm,fill] (a_scale) {$\sigma_a$};
        \node[latent,above=of b,fill] (b_scale) {$\sigma_b$};
        \node[latent,above=of g2,fill] (g2_scale) {$\sigma_{c_2}$};
        \node[latent,above=of g1,fill] (g1_scale) {$\sigma_{c_1}$};
        \node[latent,above=of L,fill] (L_scale) {$\sigma_L$};
        \node[latent,above=of H,fill] (H_scale) {$\sigma_H$};
        \node[latent,above=of v,fill] (v_scale) {$\sigma_v$};
        \node[latent,above=of ell,fill] (ell_scale) {$\sigma_\ell$};

        % Groups plate
        \plate[inner sep=.25cm, yshift=.2cm] {plate_group} {(a_mean)(a_scale)(b_scale)(g1_scale)(g2_scale)(L_scale)(H_scale)(v_scale)(ell_scale)(plate_participant)} {$g: 1, 2 \ldots N_G$};

        % GLOBAL PRIORS
        \node[latent,above=of g2_scale,xshift=.05cm,fill] (g2_scale_global_scale) {$\sigma_{\sigma_{c_2}}$};
        \node[latent,above=of g1_scale,xshift=-.05cm,fill] (g1_scale_global_scale) {$\sigma_{\sigma_{c_1}}$};
        \node[latent,above=of b_scale,fill] (b_scale_global_scale) {$\sigma_{\sigma_{b}}$};
        \node[latent,above=of L_scale,fill] (L_scale_global_scale) {$\sigma_{\sigma_L}$};
        \node[latent,above=of H_scale,fill] (H_scale_global_scale) {$\sigma_{\sigma_H}$};
        \node[latent,above=of v_scale,fill] (v_scale_global_scale) {$\sigma_{\sigma_v}$};
        \node[latent,above=of ell_scale,fill] (ell_scale_global_scale) {$\sigma_{\sigma_\ell}$};

        % Response plate
        \plate[inner sep=.1cm, yshift=.02cm] {plate_Response} {(b_scale_global_scale)(L_scale_global_scale)(H_scale_global_scale)(v_scale_global_scale)(ell_scale_global_scale)(g1_scale_global_scale)(g2_scale_global_scale)(plate_group)} {$m: 1, 2 \ldots N_M$};

        % Edges from Global-priors to Priors
        \edge {g1_scale_global_scale} {g1_scale}
        \edge {g2_scale_global_scale} {g2_scale}
        \edge {b_scale_global_scale} {b_scale}
        \edge {L_scale_global_scale} {L_scale}
        \edge {H_scale_global_scale} {H_scale}
        \edge {v_scale_global_scale} {v_scale}
        \edge {ell_scale_global_scale} {ell_scale}

        % Edges from Hyper-priors to Priors
        \edge {g1_scale} {g1}
        \edge {g2_scale} {g2}
        \edge {a_mean, a_scale} {a}
        \edge {b_scale} {b}
        \edge {L_scale} {L}
        \edge {H_scale} {H}
        \edge {v_scale} {v}
        \edge {ell_scale} {ell}

        % Edges from Priors to Deterministic
        \edge {g1, g2} {beta}
        \edge {a, b, v, L, ell, H} {mu}

        % Edges to obs
        \edge {intensity} {beta, mu}
        \edge{p_outlier} {binary_obs}
        \edge {beta,mu,binary_obs,outlier_scale} {obs};
        \edge {mu} {beta};
    }
\end{figure}


\end{document}
