\documentclass[a4paper,12pt]{article}
\usepackage{amsmath,amssymb}
\usepackage{tikz}
\usepackage{fullpage}
\usepackage{bm}
\usepackage{float}
\usetikzlibrary{bayesnet}
\DeclareMathOperator{\E}{\mathbb{E}}

\begin{document}

    In this section, we describe a mixed-effects model consististing of both fixed and random components. This model is particularly useful in settings where the same participants undergo repeated experiments. For instance, one might be interested in assessing intervention benefits by looking at how the thresholds change from pre and post intervention. Fig. 4.3.3 gives the graphical representation of such a model implemented by hbmep. In section 5.3, we use this model $($with $N_R = 2$$)$ to compare midline and lateral stimulation thresholds.

    \begin{figure}[H]
        \centering
        \tikz{ %
            % Obs
            \node[obs,fill] (obs) {$y$};%

            % Deterministic mu, beta
            \node[det,above=of obs,xshift=-1.5cm,yshift=-.5cm,fill] (beta) {$\beta$}; %
            \node[det,above=of obs,xshift=1.5cm,yshift=0cm,fill] (mu) {$\mu$}; %
            \node[obs,above=of obs,xshift=-.8cm,yshift=1cm,fill] (intensity) {$x$};%
            \plate[inner sep=.1cm, yshift=.07cm] {plate_obs} {(obs)(mu)(beta)(intensity)} {$\text{intensity }i: 1, 2 \ldots n(p, r)$};

            % % PRIORS
            % a, b, v
            \node[det,above=of obs,yshift=2.2cm,xshift=-.9cm,fill] (a) {$a$};
            \node[latent,right=of a,xshift=-.8cm,fill] (b) {$b$};
            % \node[latent,right=of b,xshift=-.9cm,fill] (v) {$v$};
            % L, H, v, ell
            \node[latent,right=of b,xshift=-.9cm,fill] (L) {$L$};
            \node[latent,right=of L,xshift=-.9cm,fill] (ell) {$\ell$};
            \node[latent,right=of ell,xshift=-.9cm,fill] (H) {$H$};
            % g1, g2
            \node[latent,left=of a,xshift=.8cm,fill] (g2) {${c_2}$};
            \node[latent,left=of g2,xshift=.9cm,fill] (g1) {${c_1}$};

            % Participants plate
            \plate[inner sep=.25cm, yshift=.2cm] {plate_participant} {(a)(b)(L)(H)(ell)(g1)(g2)(plate_obs)} {$\text{participant } p:1, 2 \ldots N_P$};

            % % HYPER-PRIORS
            \node[latent,above=of b,fill] (b_scale) {$\sigma_b$};
            % g1_scale, g2_scale, L_scale, H_scale, v_scale, ell_scale
            \node[latent,above=of g2,fill] (g2_scale) {$\sigma_{c_2}$};
            \node[latent,above=of g1,fill] (g1_scale) {$\sigma_{c_1}$};
            \node[latent,above=of L,fill] (L_scale) {$\sigma_L$};
            \node[latent,above=of H,fill] (H_scale) {$\sigma_H$};
            % \node[latent,above=of v,fill] (v_scale) {$\sigma_v$};
            \node[latent,above=of ell,fill] (ell_scale) {$\sigma_\ell$};

            % Groups plate
            \plate[inner sep=.25cm, yshift=.2cm] {plate_group} {(b_scale)(g1_scale)(g2_scale)(L_scale)(H_scale)(ell_scale)(plate_participant)} {$\text{repetition }r: 1, 2 \ldots N_R$};

            % GLOBAL PRIORS
            \node[latent,above=of g2_scale,xshift=.05cm,fill] (g2_scale_global_scale) {$\sigma_{\sigma_{c_1}}$};
            \node[latent,above=of g1_scale,xshift=-.05cm,fill] (g1_scale_global_scale) {$\sigma_{\sigma_{c_2}}$};
            \node[latent,above=of b_scale,fill] (b_scale_global_scale) {$\sigma_{\sigma_{b}}$};
            \node[latent,above=of L_scale,fill] (L_scale_global_scale) {$\sigma_{\sigma_L}$};
            \node[latent,above=of H_scale,fill] (H_scale_global_scale) {$\sigma_{\sigma_H}$};
            % \node[latent,above=of v_scale,fill] (v_scale_global_scale) {$\sigma_{\sigma_v}$};
            \node[latent,above=of ell_scale,fill] (ell_scale_global_scale) {$\sigma_{\sigma_\ell}$};

            % Edges from Global-priors to Priors
            \edge {g1_scale_global_scale} {g1_scale}
            \edge {g2_scale_global_scale} {g2_scale}
            \edge {b_scale_global_scale} {b_scale}
            \edge {L_scale_global_scale} {L_scale}
            \edge {H_scale_global_scale} {H_scale}
            \edge {ell_scale_global_scale} {ell_scale}

            % Edges from Hyper-priors to Priors
            \edge {g1_scale} {g1}
            \edge {g2_scale} {g2}
            \edge {b_scale} {b}
            \edge {L_scale} {L}
            \edge {H_scale} {H}
            \edge {ell_scale} {ell}

            % Edges from Priors to Deterministic
            \edge {g1, g2} {beta}
            \edge {a, b, L, ell, H} {mu}

            % Edges to obs
            \edge {intensity} {beta, mu}
            \edge {beta,mu} {obs};
            \edge {mu} {beta};

            % Fixed
            \node[latent,left=of a,xshift=-3cm,yshift=1.2cm,fill] (a_fixed) {$a_{\text{fixed}}$};
            \node[latent,above=of a_fixed,xshift=-.6cm,yshift=-.5cm,fill] (a_fixed_mean) {$\mu_{a_{\text{fixed}}}$};
            \node[latent,above=of a_fixed,xshift=.6cm,yshift=-.5cm,fill] (a_fixed_scale) {$\sigma_{a_{\text{fixed}}}$};
            % \plate[inner sep=.1cm, yshift=.0cm] {plate_participant_fixed} {(a_fixed)} {$p: 1, 2 \ldots N_P$};
            % \plate[inner sep=.1cm, yshift=.0cm] {plate_group_fixed} {(a_fixed_mean)(a_fixed_scale)(plate_participant_fixed)} {$h: 1$};
            \tikzset{plate caption/.style={caption, node distance=0, inner sep=0cm,
            below left=0cm and -1cm of #1.south,text height=1.2em,text depth=0.1em}}
            \plate {plate_participant_fixed} {(a_fixed)} {$p: 1, 2 \ldots N_P$};
            \tikzset{plate caption/.style={caption, node distance=0, inner sep=-.1cm,
            below left=0cm and -1cm of #1.south,text height=1.2em,text depth=0.1em}}
            \plate {plate_group_fixed} {(a_fixed_mean)(a_fixed_scale)(plate_participant_fixed)} {$r: 1$};

            % Random
            \node[latent,below=of a_fixed,yshift=-3cm,fill,minimum size=.9cm] (a_random) {$a_\Delta$};
            \node[latent,above=of a_random,xshift=-.7cm,yshift=-.5cm,fill,minimum size=.9cm] (a_random_mean) {$\mu_{a_{\Delta}}$};
            \node[latent,above=of a_random,xshift=.7cm,yshift=-.5cm,fill,minimum size=.9cm] (a_random_scale) {$\sigma_{a_{\Delta}}$};
            \tikzset{plate caption/.style={caption, node distance=0, inner sep=0cm,
            below left=0cm and -1cm of #1.south,text height=1.2em,text depth=0.1em}}
            \plate {plate_participant_random} {(a_random)} {$p: 1, 2 \ldots N_P$};
            \tikzset{plate caption/.style={caption, node distance=0, inner sep=-.05cm,
            below left=0cm and -1.2cm of #1.south,text height=1.2em,text depth=0.1em}}
            \plate {plate_group_random} {(a_random_mean)(a_random_scale)(plate_participant_random)} {$r: 2, 3 \ldots N_R$};

            % Edges for fixed
            \edge {a_fixed_mean, a_fixed_scale} {a_fixed}

            % Edges for random
            \edge {a_random_mean, a_random_scale} {a_random}

            % Edges from a_fixed and a_random to deterministic a
            \edge {a_fixed, a_random} {a}

            \tikzset{plate caption/.style={caption, node distance=0, inner sep=-.05cm,
            below left=0cm and -5.2cm of #1.south,text height=1.2em,text depth=0.1em}}
            \plate {plate_muscle} {(g2_scale_global_scale)(g1_scale_global_scale)(b_scale_global_scale)(L_scale_global_scale)(ell_scale_global_scale)(H_scale_global_scale)(plate_group)(plate_group_fixed)(plate_group_random)} {$\text{muscle }m : 1, 2 \ldots N_M$};

        }
    \end{figure}

    where threshold $a^{m, p, r}$ of participant $p$ in repetition $r$ is given by,
    \begin{align*}
        a^{m, p, r} = \begin{cases}
            {{a}_\text{fixed}}^{m, p} & r = 1 \\
            {{a}_\text{fixed}}^{m, p} + {{a}_\Delta}^{m, p, r} & r > 1
        \end{cases}\tag{4.2.4}
    \end{align*}

    A priori we assume no random effects, or lack thereof. This is reflected in the choice of a flat prior for ${\mu}_{a_{\text{random}}}$ that is symmetric about $0$. Once the model is fit, we look at the shift in the posterior distribution of ${\mu}_{a_{\text{random}}}$ to assess the strength of the random component.

\end{document}
