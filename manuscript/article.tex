%Version 3 December 2023
% See section 11 of the User Manual for version history
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%
%% Please do not use \input{...} to include other tex files.       %%
%% Submit your LaTeX manuscript as one .tex document.              %%
%%                                                                 %%
%% All additional figures and files should be attached             %%
%% separately and not embedded in the \TeX\ document itself.       %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%\documentclass[referee,sn-basic]{sn-jnl}% referee option is meant for double line spacing

%%=======================================================%%
%% to print line numbers in the margin use lineno option %%
%%=======================================================%%

%%\documentclass[lineno,sn-basic]{sn-jnl}% Basic Springer Nature Reference Style/Chemistry Reference Style

%%======================================================%%
%% to compile with pdflatex/xelatex use pdflatex option %%
%%======================================================%%

%%\documentclass[pdflatex,sn-basic]{sn-jnl}% Basic Springer Nature Reference Style/Chemistry Reference Style


%%Note: the following reference styles support Namedate and Numbered referencing. By default the style follows the most common style. To switch between the options you can add or remove Numbered in the optional parenthesis. 
%%The option is available for: sn-basic.bst, sn-vancouver.bst, sn-chicago.bst%  
 
% \documentclass[pdflatex,sn-nature]{sn-jnl}% Style for submissions to Nature Portfolio journals
% \documentclass[pdflatex,sn-basic]{sn-jnl}% Basic Springer Nature Reference Style/Chemistry Reference Style
% \documentclass[pdflatex,sn-mathphys-num]{sn-jnl}% Math and Physical Sciences Numbered Reference Style 
\documentclass[pdflatex,sn-mathphys-ay]{sn-jnl}% Math and Physical Sciences Author Year Reference Style
%%\documentclass[pdflatex,sn-aps]{sn-jnl}% American Physical Society (APS) Reference Style
%%\documentclass[pdflatex,sn-vancouver,Numbered]{sn-jnl}% Vancouver Reference Style
% \documentclass[pdflatex,sn-apa]{sn-jnl}% APA Reference Style 
% \documentclass[pdflatex,sn-chicago]{sn-jnl}% Chicago-based Humanities Reference Style

%%%% Standard Packages
%%<additional latex packages if required can be included here>

\usepackage{graphicx}%
\usepackage{multirow}%
\usepackage{amsmath,amssymb,amsfonts}%
\usepackage{amsthm}%
\usepackage{mathrsfs}%
\usepackage[title]{appendix}%
\usepackage{xcolor}%
\usepackage{textcomp}%
\usepackage{manyfoot}%
\usepackage{booktabs}%
\usepackage{algorithm}%
\usepackage{algorithmicx}%
\usepackage{algpseudocode}%
\usepackage{listings}%

\numberwithin{equation}{subsection}
%%%%

%%%%%=============================================================================%%%%
%%%%  Remarks: This template is provided to aid authors with the preparation
%%%%  of original research articles intended for submission to journals published 
%%%%  by Springer Nature. The guidance has been prepared in partnership with 
%%%%  production teams to conform to Springer Nature technical requirements. 
%%%%  Editorial and presentation requirements differ among journal portfolios and 
%%%%  research disciplines. You may find sections in this template are irrelevant 
%%%%  to your work and are empowered to omit any such section if allowed by the 
%%%%  journal you intend to submit to. The submission guidelines and policies 
%%%%  of the journal take precedence. A detailed User Manual is available in the 
%%%%  template package for technical guidance.
%%%%%=============================================================================%%%%

%% as per the requirement new theorem styles can be included as shown below
\theoremstyle{thmstyleone}%
\newtheorem{theorem}{Theorem}%  meant for continuous numbers
%%\newtheorem{theorem}{Theorem}[section]% meant for sectionwise numbers
%% optional argument [theorem] produces theorem numbering sequence instead of independent numbers for Proposition
\newtheorem{proposition}[theorem]{Proposition}%
%%\newtheorem{proposition}{Proposition}% to get separate numbers for theorem and proposition etc.

\theoremstyle{thmstyletwo}%
\newtheorem{example}{Example}%
\newtheorem{remark}{Remark}%

\theoremstyle{thmstylethree}%
\newtheorem{definition}{Definition}%

\raggedbottom
%%\unnumbered% uncomment this for unnumbered level heads

\begin{document}

\title[Article Title]{Hierarchical Bayesian estimation of motor evoked potential recruitment curves yields accurate and robust estimates}

%%=============================================================%%
%% GivenName	-> \fnm{Joergen W.}
%% Particle	-> \spfx{van der} -> surname prefix
%% FamilyName	-> \sur{Ploeg}
%% Suffix	-> \sfx{IV}
%% \author*[1,2]{\fnm{Joergen W.} \spfx{van der} \sur{Ploeg}
%%  \sfx{IV}}\email{iauthor@gmail.com}
%%=============================================================%%

\author*[1,2]{\fnm{Vishweshwar} \sur{Tyagi}}\email{vt2353@columbia.edu}

\author[8,9]{\fnm{Lynda M.} \sur{Murray}}

\author[5]{\fnm{Ahmet S.} \sur{Asan}}
% \equalcont{These authors contributed equally to this work.}

\author[3,6]{\fnm{Christopher} \sur{Mandigo}}

\author[4]{\fnm{Michael S.} \sur{Virk}}

\author[7,8,9]{\fnm{Noam Y. } \sur{Harel}}

\author[1,2,4]{\fnm{Jason B.} \sur{Carmel}}

\author*[1,2,4]{\fnm{James R.} \sur{McIntosh}}\email{jrm2263@cumc.columbia.edu}

% \affil[1]{\orgdiv{Department}, \orgname{Organization}, \orgaddress{\street{Street}, \city{City}, \postcode{10587}, \state{State}, \country{Country}}}
\affil*[1]{\orgdiv{Neurology}, \orgname{Columbia University}, \orgaddress{\city{New York}, \postcode{10032}, \state{NY}}}
\affil[2]{\orgdiv{Orthopedic Surgery}, \orgname{Columbia University}, \orgaddress{\city{New York}, \postcode{10032}, \state{NY}}}
\affil[3]{\orgdiv{Neurological Surgery}, \orgname{Columbia University}, \orgaddress{\city{New York}, \postcode{10032}, \state{NY}}}
\affil[4]{\orgdiv{Neurological Surgery}, \orgname{Weill Cornell Medicine}, \orgaddress{\city{New York}, \postcode{10065}, \state{NY}}}
\affil[5]{\orgdiv{Staley Center for Psychiatric Research}, \orgname{Broad Institute of MIT and Harvard}, \orgaddress{\city{Cambridge}, \postcode{02142}, \state{MA}}}
\affil[6]{\orgdiv{New York Presbyterian}, \orgname{The Och Spine Hospital}, \orgaddress{\city{New York}, \postcode{10034}, \state{NY}}}
\affil[7]{\orgdiv{Neurology}, \orgname{Icahn School of Medicine at Mount Sinai}, \orgaddress{\city{New York}, \postcode{10029}, \state{NY}}}
\affil[7]{\orgdiv{Rehabilitation and Human Performance}, \orgname{Icahn School of Medicine at Mount Sinai}, \orgaddress{\city{New York}, \postcode{10029}, \state{NY}}}
\affil[8]{\orgname{James J. Peters Veterans Affairs Medical Center}, \orgaddress{\city{Bronx}, \postcode{10468}, \state{NY}}}

%%==================================%%
%% Sample for unstructured abstract %%
%%==================================%%

\abstract{
    Electrical and electromagnetic stimulation probe and modulate the neural systems that control movement. Key to understanding their effects is the muscle recruitment curve, which maps evoked potential size against stimulation intensity. Current methods to estimate curve parameters require large samples; however, collecting these is often impractical due to experimental constraints. Here, we present a hierarchical Bayesian framework that accounts for small samples, handles outliers, simulates high-fidelity data, and returns posterior distributions over curve parameters that quantify estimation uncertainty. It uses a rectified-logistic function that estimates motor threshold and outranks sigmoidal alternatives in predictive performance, as demonstrated through cross-validation. In simulations, our method outperforms conventional non-hierarchical models by reducing threshold estimation error on sparse data, and requires fewer participants to detect shifts in threshold compared to frequentist testing. We present two common use cases involving electrical and electromagnetic stimulation data and provide a library for Python, called hbMEP, for diverse applications.
}

%%================================%%
%% Sample for structured abstract %%
%%================================%%

% \abstract{\textbf{Purpose:} The abstract serves both as a general introduction to the topic and as a brief, non-technical summary of the main results and their implications. The abstract must not include subheadings (unless expressly permitted in the journal's Instructions to Authors), equations or citations. As a guide the abstract should not exceed 200 words. Most journals do not set a hard limit however authors are advised to check the author instructions for the journal they are submitting to.
% 
% \textbf{Methods:} The abstract serves both as a general introduction to the topic and as a brief, non-technical summary of the main results and their implications. The abstract must not include subheadings (unless expressly permitted in the journal's Instructions to Authors), equations or citations. As a guide the abstract should not exceed 200 words. Most journals do not set a hard limit however authors are advised to check the author instructions for the journal they are submitting to.
% 
% \textbf{Results:} The abstract serves both as a general introduction to the topic and as a brief, non-technical summary of the main results and their implications. The abstract must not include subheadings (unless expressly permitted in the journal's Instructions to Authors), equations or citations. As a guide the abstract should not exceed 200 words. Most journals do not set a hard limit however authors are advised to check the author instructions for the journal they are submitting to.
% 
% \textbf{Conclusion:} The abstract serves both as a general introduction to the topic and as a brief, non-technical summary of the main results and their implications. The abstract must not include subheadings (unless expressly permitted in the journal's Instructions to Authors), equations or citations. As a guide the abstract should not exceed 200 words. Most journals do not set a hard limit however authors are advised to check the author instructions for the journal they are submitting to.}

\keywords{hierarchical Bayesian, motor threshold, transcranial magnetic stimulation, spinal cord stimulation, hypothesis testing, mathematical modeling, evoked potential}

%%\pacs[JEL Classification]{D8, H51}

%%\pacs[MSC Classification]{35A01, 65L10, 65L12, 65L20, 65L70}

\maketitle

\section{Introduction}\label{intro}

\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{Hierarchical Bayesian estimation of recruitment curves yields parametric estimates for each participant across multiple muscles simultaneously.}  \textbf{(a)} Example motor evoked potentials (MEPs) recorded at different stimulation intensities from two muscles, abductor pollicis brevis (APB) on left and abductor digiti minimi (ADM) on right. Abscissa represents stimulation intensity which may be specified in different units e.g. $\mu$A or mA for Spinal Cord Stimulation, or \% maximum stimulator output (MSO) for Transcranial Magnetic Stimulation. \textbf{Right panel:} Quantification of MEPs into MEP size using either peak-to-peak amplitude or area under curve. \textbf{(b)} Example recruitment curves estimated as 4-parameter sigmoid using mean squared error minimization with the Nelder-Mead method. It provides only point estimates for curve parameters, lacks threshold estimates, and fails to capture sharp deflection from offset. Bottom panels: point estimate of S50. \textbf{Top right panel:} point estimate of the saturation parameter. \textbf{Bottom right panel:} point estimate of the maximum gradient. \textbf{(c)} Example recruitment curves estimated as 5-parameter rectified-logistic function within a hierarchical Bayesian framework. Shading represents the 95\% highest density interval (HDI) of posterior predictive distribution. It accurately captures the threshold and S50. Additionally, it returns posterior distributions over curve parameters, quantifying estimation uncertainty using the width of the 95\% HDI. Data from multiple participants and muscles is handled simultaneously. Bottom panels: posterior distribution of threshold and S50. Inset: zoom over posterior distribution. \textbf{Top right panel:} posterior distribution of the saturation parameter. \textbf{Bottom right panel:} posterior distribution of the maximum gradient.}\label{fig-intro}
\end{figure}

\section{Results}\label{results}
\subsection{Choice of recruitment curve function}\label{res-choice}
\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{Rectified-logistic recruitment curve outranks traditionally used alternatives based on Bayesian cross-validation while having the unique advantage of estimating threshold and $\textbf{S}_\mathbf{50}$.} \textbf{(a)} Example recruitment curve (RC) fitted to rat epidural Spinal Cord Stimulation (SCS) biceps data (gray dots) using 3-parameter rectified-linear function. Black line shows the RC. Gray shading represents the 95\% highest density interval (HDI) of the posterior predictive distribution. It undershoots data at low intensities due to curvature in data, and subsequently overshoots, failing to capture saturation which results in wide 95\% HDI. It estimates threshold but not S$_{50}$, since it doesn’t saturate. \textbf{(b)} 4-parameter sigmoid (logistic-4) captures the saturation but fails to capture the sharp deflection from offset due to its symmetry about the inflection point. It estimates S$_{50}$ and lacks threshold estimate. \textbf{(c)} 5-parameter sigmoid (logistic-5) function improves upon this by better capturing the deflection. It estimates S$_{50}$ and lacks threshold estimate. \textbf{(d)} 5-parameter rectified-logistic function is flexible enough to accurately capture the deflection, curvature, and saturation, resulting in narrower 95\% HDI. It estimates both threshold and S$_{50}$. \textbf{(e)} Predictive performance measured with expected log-pointwise predictive density (ELPD) leave-one-out cross-validation on rat epidural SCS dataset, consisting of 3 muscles, 450 RCs, and 23,028 motor evoked potentials (MEPs). Black circles represent mean ELPD score, black bars represent standard error of ELPD mean, gray triangles represent mean of pairwise ELPD differences from the best-ranked rectified-logistic model, and gray bars represent standard error of pairwise differences. \textbf{(f)} As for (e), but on human Transcranial Magnetic Stimulation dataset, consisting of 6 muscles, 114 RCs, and 8,490 MEPs. \textbf{(g)} As for (e), but on human epidural SCS dataset, consisting of 3 muscles, 78 RCs, and 3,453 MEPs. The predictive performance of rectified-logistic function is significantly better than logistic-5 on the largest tested rat SCS dataset, and it is comparable to logistic-5 on human TMS and SCS datasets.}\label{fig-choice}
\end{figure}

\subsection{Robustness \& efficiency}\label{res-robustness}
\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{(a--d) Generative capability of the hierarchical Bayesian framework enables simulation of high fidelity synthetic data.} \textbf{(a)} Example participant from Transcranial Magnetic Stimulation (TMS) data that is used by hierarchical Bayesian model to estimate the participant-level and population-level parameters. \textbf{(b)} Data simulated from the model conditioned on estimated participant-level parameters. The model can replicate the observed participants. \textbf{(c)} Data simulated from the model conditioned on estimated population-level parameters. The model can simulate new participants for subsequent model comparison. \textbf{(d)} A principal component analysis plot shows a large overlap between the new simulated parameters (blue dots) and those estimated from observed TMS data (orange dots). A large overlap signifies that the generated synthetic data closely matches real TMS data. Green dots represent parameters simulated from the prior predictive distribution, which is weakly informative as indicated by its large spread. \textbf{(e--f) Hierarchical Bayesian structure improves threshold estimation accuracy over non-Bayesian and non-hierarchical models on simulated data.} \textbf{(e)} For a single participant, both non-hierarchical Bayesian (nHB) and hierarchical Bayesian (HB) models produce the same mean absolute error (MAE), which is lower than traditionally used maximum likelihood (ML) and Nelder-Mead (NM) methods. With an increase in the number of participants, the HB model uses partial pooling across participants to further reduce error. This simulation consisted of 48 equispaced stimulation intensities between 0--100\% maximum stimulator output (MSO), and was repeated 2000 times. Error bars represent standard error of the mean. \textbf{(f)} For eight simulated participants, the HB model outperforms other non-hierarchical methods at all tested number of stimulation intensities. Advantage of the HB model is largest for low number of intensities, i.e., on sparse data. This simulation consisted of 8 participants and was repeated 2000 times. \textbf{(g--h) Hierarchical Bayesian estimation is more powerful and produces fewer false positives when detecting shifts in threshold on simulated data.} \textbf{(g)} Comparison of statistical power of Bayesian estimation versus non-hierarchical models to detect a negative shift in threshold parameter from pre- to post-intervention. Bayesian estimation is more powerful and requires approximately 35\% fewer participants to achieve 80\% statistical power compared to nHB. The threshold differences were simulated from a normal distribution $\text{Normal}\left(-3, 1.5\right)$, where the null hypothesis (no threshold shift) is false. Bayesian estimation rejects the null if the 95\% highest density interval is entirely left of zero. This was compared with a one-sided Wilcoxon signed-rank test on point estimates of pairwise threshold differences estimated using non-hierarchical models (a t-test was not applicable due to non-normality of estimated differences indicated by Shapiro-Wilk test). The significance level was set at 5\% for the signed rank test. This simulation was repeated 2000 times. \textbf{(h)} Comparison of false positive rates of Bayesian estimation against the set significance level of 5\%. Bayesian estimation is more conservative in falsely rejecting the null hypothesis and maintains a false positive rate between 0 and 2.5\%. The differences were simulated from $\text{Normal}\left(0, 1.5\right)$, where the null hypothesis holds true. This simulation was repeated 2000 times.}\label{fig-robustness}
\end{figure}

\subsubsection{Simulated data and posterior predictive checks}\label{res-simulation}
\subsubsection{Accuracy on sparse data}\label{res-accuracy}
\subsubsection{Statistical power}\label{res-power}
\subsection{Common use cases}\label{res-uses}
\subsubsection{Within-participants comparison}
\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{Within-participant comparison, midline versus lateral stimulation example on human epidural Spinal Cord Stimulation data.} \textbf{(a)} Example participant with lateral (light) and midline (dark) stimulation. Inset: zoom to show presence of threshold, despite small MEP size. \textbf{Bottom panels:} Posterior distribution of threshold. Inset: zoom over posterior distribution. \textbf{(b)} Posterior distribution of difference between midline and lateral thresholds summarized across 13 participants who underwent intraoperative surgery. A priori, the model assumes no difference between midline and lateral thresholds, indicated by a flat prior (gray distribution) centered at zero. The 95\% highest density interval (HDI) of the posterior suggests strong evidence in favor of lateral stimulation being more effective.}\label{fig-within}
\end{figure}

\subsubsection{Between-groups comparison}
\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{Between-groups comparison, SCI versus uninjured participants example on Human Transcranial Magnetic Stimulation (TMS) data.} \textbf{(a)} Example uninjured participant. Inset: zoom to show presence of threshold, despite small MEP size. Bottom panels: Posterior distribution of threshold. \textbf{(b)} participant with spinal cord injury (SCI). \textbf{(c)} Posterior distribution of threshold difference summarized between 12 uninjured and 7 SCI participants. A priori, the model assumes no difference, indicated by a flat prior (gray distribution) centered at zero. Although not significant, the mass of posterior distribution indicates with high probability that spinal cord injury is associated with higher thresholds.}\label{fig-between}
\end{figure}

\subsubsection{Optimizing experimental design}

\section{Discussion}\label{discussion}

\section{Methods}\label{methods}
\subsection{Modeling MEP size}\label{modeling}
The various choices for modeling recruitment curves include 3-parameter rectified-linear \cite{willer_hypoxia_1987,devanne_input-output_1997,malone_closed-loop_2022-1,mcintosh_intraoperative_2023} (Eq. \ref{eq411}, Fig. \ref{fig-choice}a), 4-parameter logistic-4 \cite{devanne_input-output_1997,kukke_efficient_2014} (Eq. \ref{eq412}, Fig. \ref{fig-choice}b). Additionally, 5-parameter logistic-5 \cite{pitcher_age_2003} (Eq. \ref{eq413}, Fig. \ref{fig-choice}c) is a more generalized version of logistic-4 and contains an extra parameter $v$ to control near which asymptote (lower $L$ or upper $L + H$) the maximum growth or point of inflection occurs. In contrast to logistic-4, the logistic-5 is not necessarily symmetrical about its inflection point.
\begin{align}
    &\text{rectified-linear} & \forall a, b, L > 0\ \;\;&x \mapsto L + \max\left\{0, b\left(x - a\right)\right\}  \label{eq411}\\
    &\text{logistic-4} & \forall a, b, L, H > 0\ \;\;&x \mapsto L + \frac{H}{1 + e^{-b\left(x-a\right)}}  \label{eq412}\\
    &\text{logistic-5} & \forall a, b, v, L, H > 0\ \;\;&x \mapsto L + \frac{H}{\left\{1 + \left(2^v - 1\right)e^{-b\left(x-a\right)}\right\}^{1/v}}  \label{eq413}
\end{align}

Note that in Eq. \ref{eq411}, parameter $a$ models the threshold, and in Eq. \ref{eq412}, \ref{eq413} it models the $\text{S}_{50}$. $L$ represents the offset MEP size, $\left(L + H\right)$ defines the saturation, and $b$ is the growth rate. The logistic functions do not have a direct representation of threshold since they are smooth, and the rectified-linear function does not have a direct representation of $\text{S}_{50}$ since it doesn’t saturate.

\subsubsection{Observation model}

We introduce a rectified-logistic function (Eq. \ref{eq414}) that can estimate both the threshold and $\text{S}_{50}$. Fig. \ref{fig-default}a--f shows the effect of varying its parameters. Parameters $L, H, b$ have similar interpretation as in the logistic-4 function, and $a$ models the threshold. Eq. \ref{eq415} gives the $\text{S}_{50}$ of rectified-logistic function. Similar to logistic-5, there is an additional parameter $\ell$ (Fig. \ref{fig-default}e) that controls the location of inflection point, or the point of maximum gradient, whether near the offset $L$ or saturation $\left(L + H\right)$.
\begin{align}
    \intertext{For $a, b, L, \ell, H > 0$, define $\mathcal{F}: \mathbb{R} \to \mathbb{R}^{+}$ as}
    \mathcal{F}\left(x\right) &= L + \max\left\{0, -\ell + \frac{H + \ell}{1 + \left(\frac{H}{\ell}\right)e^{-b\left(x-a\right)}} \right\} \label{eq414}\\
    % &{\text{S}_{50}}_{\mathcal{F}} = a - \frac1b\ln\left(\frac{\ell}{H}\left(\frac{\ell}{2H + \ell}\right)\right)
    {\text{S}_{50}}\left(\mathcal{F}\right)&= a - \frac1b\ln\left(\frac{H\ell}{H\left(H + 2\ell\right)}\right) \label{eq415}
\end{align}

\begin{figure}[h]
    \centering
    % \includegraphics[width=\textwidth]{figures/fig06.png}
    \caption{\textbf{(a--f) Effect of varying parameters of rectified-logistic function.} \textbf{(a)} Varying $a$ shifts the threshold. \textbf{(b)} $b$ changes the growth rate. $L$ changes the offset MEP size. \textbf{(c)} $H$ changes the distance between offset and saturation $\left(L + H\right)$ \textbf{(d)} Varying $H$ changes the saturation. \textbf{(e)} $\ell$ affects where inflection point or maximum gradient occurs, near offset $L$, or saturation $\left(L + H\right)$. \textbf{(f)} Varying $b, \ell$ simultaneously. \textbf{(g--h) Hierarchical Bayesian model structure.} \textbf{(g)} Graphical model of hierarchical Bayesian model used to estimate population-level parameters of Transcranial Magnetic Stimulation (TMS) data. The model yields parameter estimates for each participant across multiple muscles simultaneously. Circular nodes represent random variables. Filled circular nodes represent observed data. Diamonds represent deterministic variables. Arrows represent that the child node is informed by the distribution of the parent node. Plates denote the re-instantiation of nodes. \textbf{(h)} Bayesian model specification with participant- and population-level parameters, and weakly-informative hyperpriors. Weakly informative hyperpriors help combine data from multiple participants in a principled way making the model less vulnerable to overfitting.}\label{fig-default}
\end{figure}

We use a gamma (in shape-rate parametrization) observation model (Eq. \ref{eq416}--\ref{eq418}) to model the relationship between MEP size $\left(y\right)$ and stimulation intensity $\left(x\right)$. Note that in Eq. \ref{eq417}, we model the expected MEP size as a rectified-logistic function of intensity, since $\mathbb{E}\left(y \mid x, \Omega, c_1, c_2\right) = \mu = \mathcal{F}\left(x\mid\Omega\right)$.
\begin{align}
    \intertext{For $c_1, c_2 > 0$}
    y \mid x, \Omega, c_1, c_2 &\sim \text{Gamma}\left(\mu\cdot\beta, \beta\right) \label{eq416}\\
    \mu & = \mathcal{F}\left(x \mid \Omega\right) \label{eq417} \hspace{40pt}{\Omega} = \left\{a, b, L, \ell, H\right\}\\
    \beta &= \frac{1}{c_1} + \frac{1}{c_2\cdot\mu} \label{eq418}
\end{align}

We chose a gamma distribution to capture the long tailed heteroskedasticity noise spread (Goetz and before \ref{placeholder}) around the recruitment curve. In Eq. \ref{eq418} we specify the rate parameter $\left(\beta\right)$ as a linear function of the reciprocal of expected MEP size $\left(\frac1\mu\right)$ with positive weights $\left(\frac1{c_1}, \frac1{c_2}\right)$, which allows capturing the increase in noise spread as MEP size increases. The Bayesian framework enables inferring posterior distributions over curve parameters. Estimation uncertainty can be quantified using the width of 95\% highest density interval (HDI) of posterior distributions.

\subsubsection{Recruitment Curves}
More generally, in Eq. \ref{eq417}, $\mathcal{F}$ is called the activation function, or, the recruitment curve in the context of modeling MEP size, which transforms the input stimulation intensity $\left(x\right)$, and links it to the expected MEP size $\mathbb{E}\left(y\mid x\right)$. $\mathcal{F}$ can be replaced by other available choices, including rectified-linear, logistic-4, or logistic-5.

\subsection{Hierarchical Bayesian Model}
\subsubsection{Default model}\label{meth-default}
The simplest form of a standard 3-stage hierarchical Bayesian model (Eq. \ref{eq421}--\ref{eq423}) in the context of modeling MEP size can be described as follows. Let there be $N_M \times N_P$ exchangeable sequences $\left\{\left({x_i}^{p}, {y_i}^{p,m}\right)_{i=1}^{n(p)} \mid p = 1\ldots N_P, m = 1\ldots N_M\right\}$ of MEP sizes ${y_i}^{p,m} \in \mathbb{R}^+$ recorded at stimulation intensity ${x_i}^p \in \mathbb{R}^+\cup\{0\}$ from muscle $m$ of participant $p$, for  a total of $N_M$ muscles and $N_P$ participants. Here $n(p)$ denotes the number of intensities tested for participant $p$ and ${y_i}^{p,m}$ is the MEP size recorded simultaneously from muscles $m=1,\ldots N_M$ at a given intensity ${x_i}^p$ for participant $p$.

The first stage of hierarchy is the participant-level (Eq. \ref{eq421}). It specifies the parametric models $P\left({y_i}^{p,m} \mid {x_i}^p, \theta^{p,m}\right)$ for each of the $N_M$ muscles of $N_P$ participants, and models the MEP size ${y_i}^{p,m}$ as a function of intensity ${x_i}^p$ and participant-level parameters $\theta^{p,m}$. In the second stage (Eq. \ref{eq422}), the participant-level parameters $\theta^{p,m}$ are assumed to be generated from a common distribution $P\left(\theta^{p,m} \mid \gamma\right)$ with population-level hyper-parameters $\gamma$. In the third stage (Eq. \ref{eq423}), the population-level hyper-parameters $\gamma$ are assumed to be unknown and assigned a weakly-informative prior $P\left(\gamma\right)$, also called hyperprior.
\begin{align}
    &\text{Stage I} &{y_i}^{p,m} &\sim P\left({y_i}^{p,m} \mid {x_i}^p, \theta^{p,m}\right)& \label{eq421}\\
    &\text{Stage II} &\theta^{p,m} &\sim P\left(\theta^{p,m} \mid \gamma\right)& \label{eq422}\\
    &\text{Stage III} &\gamma &\sim P\left(\gamma\right)& \label{eq423}
\end{align}
Figure \ref{fig-default}g,h specifies the default model used on human TMS data in Results \ref{res-choice}, \ref{res-simulation}.

\bigskip\noindent In Results \ref{res-choice} (Fig. \ref{fig-choice}e--g), we used the default model structure (Fig. \ref{fig-default}g) for cross-validation \cite{vehtari_practical_2017}. The participant-level parameters of the rectified-logistic function were replaced with those of rectified-linear, logistic-4 and logistic-5. Supplementary Fig. \ref{sufig-reclog-rat}--\ref{sufig-reclin-intraop} specify the models for each function on rat epidural SCS, human TMS and human epidural SCS datasets. For the rat epidural SCS data, 150 recruitment curves (RCs) were simultaneously fit on three muscles: biceps, extensor carpi radialis longus (ECR), and triceps--for a total of 450 RCs. For the human TMS data, \textbf{[**update**]} 27 RCs  were simultaneously fit on six muscles: abductor digiti minimi (ADM), abductor pollicis brevis (APB), biceps, extensor carpi radialis (ECR), flexor carpi radialis (FCR), and triceps—for a total of 114 RCs. For the human SCS data, 26 RCs were simultaneously fit on three muscles: ADM, APB, and triceps—for a total of 78 RCs. An arviz \cite{kumar_arviz_2019} implementation of cross-validation \cite{vehtari_practical_2017} was used to compute expected log-pointwise predictive density (ELPD) scores and pairwise differences between models.

\bigskip\noindent In Results \ref{res-simulation} (Fig. \ref{fig-robustness}a--d), we used the default model (Fig. \ref{fig-default}g,h) to estimate participant-level and population-level parameters from TMS data in Results 2.2.1. We used data from the APB muscle, which was the target muscle for 21 of the total 27 participants. The model was conditioned on estimated participant-level parameters to replicate the observed participants (Fig. \ref{fig-robustness}b). It was conditioned on estimated population-level parameters to simulate new participants (Fig. \ref{fig-robustness}c). A principal component analysis (PCA) plot was used to visualize the participant-level parameters on a 2D plane (Fig. \ref{fig-robustness}d). The PCA map was fit on parameters simulated from the prior predictive distribution (Fig. \ref{fig-robustness}d, \textbf{??} dots). The map was used to transform parameters estimated from observed TMS participants (Fig. \ref{fig-robustness}d, \textbf{??} dots) and parameters of new simulated participants (Fig. \ref{fig-robustness}d, \textbf{??} dots).

\subsubsection{Within-participants comparison}
This section presents a hierarchical model that is useful for modeling shifts in curve parameters. This is applicable in settings where the same set of participants are tested for multiple experimental conditions, such as pre- and post-intervention phases, stimulation location (e.g. midline or lateral), or stimulation parameters (e.g. electrode position, stimulation frequency).

Supplementary Fig. \ref{sufig-within} gives the graphical representation of such a model used to summarize differences in the threshold parameter. Here, we have the threshold $a^{p,k,m}$ of participant $p$, muscle $m$, at tested condition $k$ given by,
\begin{align}
    a^{p, k, m} = \begin{cases}
        {{a}_\text{fixed}}^{p, m} & k = 1 \\
        {{a}_\text{fixed}}^{p, m} + {{a}_\Delta}^{p, k, m} & k > 1
    \end{cases}\label{eq424}
\end{align}

The threshold is broken (Eq. \ref{eq424}) into a fixed component $\left(k = 1\right)$ and a shift component $\left(\forall k > 1\right)$ that measures the difference from the fixed component. This shift component is parametrized by condition-muscle-level location $\left({\mu_{a_{\Delta}}}^{k,m}\right)$ and population-level scale $\left(\sigma_{a_\Delta}\right)$ hyperparameters. The location parameter summarizes the shift within participants of each additional tested condition $\left(\forall k > 1\right)$ from the fixed component $\left(k = 1\right)$ for each muscle. The scale parameter measures the overall variability in the estimated shifts.

Additionally, this location hyperparameter $\left({\mu_{a_{\Delta}}}^{k,m}\right)$ is partially pooled across conditions and muscles and given location $\left(\mu_{\mu_{a_\Delta}}\right)$ \& scale $\left(\sigma_{\mu_{a_\Delta}}\right)$ hyperparameters. This partial pooling is done to account for multiple comparisons \cite{gelman_type_2000,gelman_why_2009} across tested conditions and muscles.

A priori we assume there is no shift from the fixed component and $\mu_{\mu_{a_\Delta}}$ is given a flat prior which is symmetric about zero. Once the model is fit, the 95\% highest density interval (HDI) of ${\mu_{a_{\Delta}}}^{k,m}$ posterior is used to assess the strength of shift from the fixed component at every muscle. Additionally, the 95\% HDI of $\mu_{\mu_{a_\Delta}}$ posterior is used to assess the overall shift across all muscles and conditions.

\subsubsection{Between-groups comparison}
Supplementary Fig. \ref{sufig-between} gives a hierarchical model used to compare threshold between different groups of participants. The parameter of interest, threshold in this case, is parameterized by group-muscle-level location $\left({\mu_a}^{g,m}\right)$ and population-level scale $\left(\sigma_a\right)$ hyperparameters. The location parameter summarizes the thresholds of all participants belonging to a group. The scale parameter summarizes the overall variability.

Additionally, this location hyperparameter $\left({\mu_a}^{g,m}\right)$ is partially pooled across groups and muscles and given location $\left(\mu_{\mu_a}\right)$ \& scale $\left(\sigma_{\mu_a}\right)$ hyperparameters. Once the model is fit, the 95\% HDI of ${\mu_{a}}^{g,m}$ posterior is used to compare the parameter between groups.

\subsubsection{Extension to mixture model}

The models discussed so far can be extended to handle outliers by replacing the gamma distribution (Eq. \ref{eq416}) with a 2-component mixture of the gamma and a half-normal distribution. The resultant observation model is given as,
\begin{align}
    y \mid x &\sim \left(1 - q_y\right)\cdot\text{Gamma}\left(\mu\cdot\beta, \beta\right) + q_y \cdot \text{HalfNormal}\left(\sigma_{\text{outlier}}\right) \label{eq425} \\
    q_y &\sim \text{Bernoulli}\left(p_{\text{outlier}}\right) \label{eq426} \\
    p_{\text{outlier}} &\sim \text{Uniform}\left(0, C_{p_{\text{outlier}}}\right) \label{eq427} \\
    \sigma_{\text{outlier}} &\sim \text{HalfNormal}\left(C_{\sigma_{\text{outlier}}}\right)\label{eq428}
\end{align}

where $C_{p_{\text{outlier}}}, C_{\sigma_{\text{outlier}}} > 0$ are constants and $C_{p_{\text{outlier}}} < 1$ is chosen to be small, usually in the range $0.01 - 0.05$. Intuitively, this means that we expect roughly $1\% - 5\%$ of outliers to be captured by the half-normal distribution. Supplementary Fig. \ref{sufig-default-mixture} shows an extension of the default model (Methods \ref{meth-default}) to the mixture model.

\bigskip\noindent In Supplementary Fig. \ref{sufig-mixture}, the default model (Methods \ref{meth-default}) with rectified-logistic function and Gamma observation was cross-validated against its mixture extension. Supplementary Fig. \ref{sufig-mixture-rat}--\ref{sufig-mixture-intraop} specify the mixture model for the three datasets that were used in Results \ref{res-choice}.

\bibliography{bibliography}% common bib file
%% if required, the content of .bbl file can be included here once bbl is generated
%%\input sn-article.bbl

\section{Additional information}

\section{Supplementary information}

\end{document}
